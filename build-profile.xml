<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright 2000-2011 JetBrains s.r.o.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<project name="clearcase-profiling" default="profileAll" basedir=".">

    <import file="build.xml" />

    <propertyfile file="build.properties" />

    <property environment="env" />
    <property name="debuglevel" value="source,lines,vars" />
    <property name="target" value="1.5" />
    <property name="source" value="1.5" />

    <property name="tests.project.location" value="${basedir}/clearcase-test" />
    <property name="profiler.agent.lib" value="${tests.project.location}/lib/profile.jar" />
    <property name="profiler.agent.config" value="${tests.project.location}/lib/profile.properties" />
    <property name="profiler.agent.output" value="${tests.project.location}/profiles" />
    <property name="tests.testoutput.dir" value="${tests.project.location}/bin" />
    <property name="tests.testreports.output.dir" value="${tests.project.location}/test-reports" />
    <property name="plugin.unpacked.lib" value="${dist}/unpacked" />
    <property name="tests.profiling.output.dir" value="${dist}/profiles" />

    <path id="teamcity.agents.libs">
        <fileset dir="${path.variable.teamcitydistribution}/buildAgent/lib">
            <include name="*.jar" />
        </fileset>
    </path>

    <path id="teamcity.server.libs">
        <fileset dir="${path.variable.teamcitydistribution}/webapps/ROOT/WEB-INF/lib">
            <include name="*.jar" />
        </fileset>
    </path>

    <path id="clearcase.plugin.jars">
        <fileset dir="${plugin.unpacked.lib}">
            <include name="*.jar" />
        </fileset>
    </path>

    <path id="tests.classpath">
        <fileset dir="${tests.project.location}/lib">
            <include name="*.jar" />
        </fileset>
        <path refid="clearcase.plugin.jars" />
        <path refid="teamcity.agents.libs" />
        <path refid="teamcity.server.libs" />
        <pathelement location="${tests.testoutput.dir}" />
    </path>

    <target name="build-test" description="Building tests">
        <!--pathconvert pathsep="${line.separator}" property="echo.classpath" refid="tests.classpath" />
        <echo message="The following classpath is associated with junit: ${echo.classpath}" /-->
        <javac destdir="${tests.testoutput.dir}" debug="on">
            <src path="${tests.project.location}/junitwrappers/src" />
            <src path="${tests.project.location}/src" />
            <exclude name="jetbrains/buildServer/vcs/clearcase/**/*Patch*.java" />
            <classpath refid="tests.classpath" />
        </javac>

    </target>

    <target name="profileAll" depends="profile-debug,profile">
    </target>

    <target name="profile-debug">
        <echo message="path.variable.teamcitydistribution: '${path.variable.teamcitydistribution}'"/>
    </target>

    <target name="profile" depends="debug,profile-clean,profile-init,build-test" description="Build underlying resources and runs JIP profiling">
        <junit printsummary="on" fork="true" haltonfailure="false" haltonerror="false" failureproperty="failure_found" showoutput="true">
            <jvmarg value="-javaagent:${profiler.agent.lib}" />
            <jvmarg value="-Dprofile.properties=${profiler.agent.config}" />
            <classpath>
                <path refid="tests.classpath" />
            </classpath>
            <formatter type="xml" />
            <batchtest todir="${tests.testreports.output.dir}">
                <fileset dir="${tests.testoutput.dir}">
                    <include name="**/junit/**/*Test*.class" />
                </fileset>
            </batchtest>
        </junit>
    </target>

    <target name="profile-clean">
        <delete dir="${tests.profiling.output.dir}" failonerror="false" quiet="true" />
        <delete dir="${tests.project.location}/bin" failonerror="false" quiet="true" />
        <delete dir="${tests.testreports.output.dir}" failonerror="false" quiet="true" />
        <delete dir="${profiler.agent.output}" failonerror="false" quiet="true" />
    </target>

    <target name="profile-init">
        <mkdir dir="${tests.project.location}/bin" />
        <mkdir dir="${tests.testreports.output.dir}" />
        <mkdir dir="${tests.profiling.output.dir}" />
        <mkdir dir="${profiler.agent.output}" />
        <mkdir dir="${plugin.unpacked.lib}" />
        <!-- extract jars from the plugin's archive for testing and profiling -->
        <unzip src="${dist}/clearcase.zip" dest="${dist}" overwrite="yes">
            <patternset>
                <include name="agent/clearcase-agent.zip" />
                <include name="server/*.jar" />
            </patternset>
        </unzip>
        <move todir="${dist}">
            <fileset dir="${dist}/server" />
            <fileset dir="${dist}/agent" />
        </move>
        <echo message="clearcase-agent/lib/clearcase-agent.jar" />
        <unzip src="${dist}/clearcase-agent.zip" dest="${dist}" overwrite="yes">
            <patternset>
                <include name="clearcase-agent/lib/clearcase-agent.jar" />
            </patternset>
        </unzip>
        <move file="${dist}/clearcase-agent/lib/clearcase-agent.jar" todir="${dist}" />
        <delete dir="${dist}/clearcase-agent" failonerror="false" quiet="true" />
        <delete file="${dist}/clearcase-agent.zip" failonerror="false" quiet="true" />
        <move todir="${plugin.unpacked.lib}">
            <fileset dir="${dist}">
                <include name="*.jar" />
            </fileset>
        </move>

    </target>



</project>